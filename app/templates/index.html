<!DOCTYPE html>
<html>
<head>
  <title>Material Compare</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>

{% if toast %}
  <div style="padding:10px;border:1px solid #cfe3cf;background:#eaffea;margin-bottom:12px;">
    {{ toast }}
  </div>
{% endif %}

<div style="display:flex; gap:18px; align-items:flex-start;">

  <!-- LEFT: Saved Jobs (Project folders) -->
  <div style="width:280px; border:1px solid #ddd; padding:12px; position:sticky; top:12px;">
    <h3 style="margin-top:0;">Saved Jobs</h3>
    <p style="margin-top:-6px; color:#666; font-size:13px;">
      Save a basket as a job, then reload it later.
    </p>

    {% if jobs and jobs|length > 0 %}
      <div style="display:flex; flex-direction:column; gap:10px;">
        {% for jid, job in jobs %}
          <div style="border:1px solid #eee; padding:10px;">
            <div style="font-weight:bold;">{{ job.name }}</div>
            <div style="font-size:12px; color:#666; margin-top:2px;">
              Mode: {{ "Single" if job.purchase_mode=="single" else "Split" }} · VAT: {{ "Ex" if job.vat_mode=="ex" else "Inc" }}
            </div>

            <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
              <a href="/?job_id={{ jid }}">Load</a>

              <form method="post" action="/delete" style="margin:0;">
                <input type="hidden" name="job_id" value="{{ jid }}">
                <button type="submit" style="padding:4px 8px;">Delete</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="padding:10px; border:1px dashed #ddd; color:#666;">
        No saved jobs yet.
      </div>
    {% endif %}
  </div>

  <!-- RIGHT: Main Pricing Tool -->
  <div style="flex:1;">

    <h1 style="margin-top:0;">Material Price Comparison</h1>
    <p style="color:#555; margin-top:-8px;">
      Builder-first pricing. Prices shown as if you are logged into your trade accounts.
    </p>

    <div style="padding:10px; border:1px solid #ddd; margin: 12px 0; color:#555;">
      <strong>Price labels:</strong>
      <span style="margin-left:8px;"><strong>Online price</strong> = public website price.</span>
      <span style="margin-left:8px;"><strong>My account</strong> = your trade account pricing (can vary by branch & terms).</span>
    </div>

    <!-- CALCULATE FORM -->
    <form method="post" action="/">

      <div style="display:flex; gap:16px; flex-wrap:wrap; margin: 10px 0 18px 0; padding: 10px; border: 1px solid #ddd;">
        <div>
          <strong>VAT:</strong>
          <label style="margin-left:10px;">
            <input type="radio" name="vat_mode" value="ex" {% if vat_mode=="ex" %}checked{% endif %}>
            Ex VAT
          </label>
          <label style="margin-left:10px;">
            <input type="radio" name="vat_mode" value="inc" {% if vat_mode=="inc" %}checked{% endif %}>
            Inc VAT
          </label>
        </div>

        <div>
          <strong>Mode:</strong>
          <label style="margin-left:10px;">
            <input type="radio" name="purchase_mode" value="single" {% if purchase_mode=="single" %}checked{% endif %}>
            Single supplier
          </label>
          <label style="margin-left:10px;">
            <input type="radio" name="purchase_mode" value="split" {% if purchase_mode=="split" %}checked{% endif %}>
            Split basket (cheapest per item)
          </label>
        </div>
      </div>

      <table>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          {% for s in suppliers %}
            <th>
              {{ s }}<br>
              <span style="font-size:12px; color:#666;">
                {% if supplier_price_type.get(s) == "Account" %}My account{% else %}Online price{% endif %}
              </span>
            </th>
          {% endfor %}
        </tr>

        {% for p in products %}
          <tr>
            <td>{{ p.name }}</td>
            <td><input type="number" name="qty_{{ p.id }}" min="0" value="{{ qty_map.get(p.id,0) }}" style="width:70px;"></td>
            {% for s in suppliers %}
              <td>£{{ "%.2f"|format(p.prices[s]) }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table>

      <br>
      <button type="submit">Calculate</button>

    </form>

    {% if any_qty %}

      <hr style="margin: 25px 0;">

      <h2>Results</h2>

      {% if purchase_mode == "split" %}
        <div style="padding:12px; border:1px solid #ddd; margin: 15px 0; background:#f7fbff;">
          <strong>Selected mode:</strong> Split basket (cheapest per item)<br>
          <strong>Split total ({{ "Inc VAT" if vat_mode=="inc" else "Ex VAT" }}):</strong>
          £{{ "%.2f"|format(split_total_mode) }}
          {% if saving_split_vs_best_single is not none %}
            {% if saving_split_vs_best_single > 0 %}
              <span style="margin-left:10px;">(saves £{{ "%.2f"|format(saving_split_vs_best_single) }} vs best single supplier)</span>
            {% elif saving_split_vs_best_single < 0 %}
              <span style="margin-left:10px;">(costs £{{ "%.2f"|format(-saving_split_vs_best_single) }} more than best single supplier)</span>
            {% endif %}
          {% endif %}
        </div>
      {% else %}
        <div style="padding:12px; border:1px solid #ddd; margin: 15px 0; background:#f7fbff;">
          <strong>Selected mode:</strong> Single supplier<br>
          <strong>Best single supplier ({{ "Inc VAT" if vat_mode=="inc" else "Ex VAT" }}):</strong>
          {{ best_single_supplier }} — £{{ "%.2f"|format(best_single_total_mode) }}
          <span style="margin-left:10px; color:#666;">
            ({% if supplier_price_type.get(best_single_supplier) == "Account" %}My account{% else %}Online price{% endif %})
          </span>
          {% if saving_split_vs_best_single is not none and saving_split_vs_best_single > 0 %}
            <span style="margin-left:10px;">(you could save £{{ "%.2f"|format(saving_split_vs_best_single) }} by splitting)</span>
          {% endif %}
        </div>
      {% endif %}

      <h3>Single supplier totals</h3>
      <table>
        <tr>
          <th>Supplier</th>
          <th>Price basis</th>
          <th>Total Ex VAT</th>
          <th>Total Inc VAT</th>
        </tr>

        {% set sorted_single = totals_mode_single|dictsort(by='value') %}
        {% for supplier, _ in sorted_single %}
          <tr {% if supplier == best_single_supplier %}style="background:#eaffea; font-weight:bold;"{% endif %}>
            <td>{{ supplier }}</td>
            <td style="color:#666;">
              {% if supplier_price_type.get(supplier) == "Account" %}My account{% else %}Online price{% endif %}
            </td>
            <td>£{{ "%.2f"|format(totals_ex_single[supplier]) }}</td>
            <td>£{{ "%.2f"|format(totals_inc_single[supplier]) }}</td>
          </tr>
        {% endfor %}
      </table>

      <h3 style="margin-top:22px;">Split basket total</h3>
      <table>
        <tr><th>Split total Ex VAT</th><th>Split total Inc VAT</th></tr>
        <tr>
          <td>£{{ "%.2f"|format(split_total_ex) }}</td>
          <td>£{{ "%.2f"|format(split_total_inc) }}</td>
        </tr>
      </table>

      <div style="margin-top:14px; padding:12px; border:1px solid #ddd;">
        <strong>Split basket picks:</strong> (winner per line by unit price)
        <ul style="margin:10px 0 0 18px;">
          {% for line in split_lines %}
            <li>
              {{ line.qty }} × {{ line.name }} →
              <strong>{{ line.chosen_supplier }}</strong>
              <span style="color:#666;">({% if line.price_type=="Account" %}My account{% else %}Online price{% endif %})</span>
              — £{{ "%.2f"|format(line.chosen_unit_ex) }} ex VAT/unit
            </li>
          {% endfor %}
        </ul>
      </div>

      <!-- SAVE JOB (Project folder) -->
      <hr style="margin: 25px 0;">

      <h2>Save as a Job</h2>
      <p style="color:#555; margin-top:-8px;">Save these quantities + settings as a project folder.</p>

      <form method="post" action="/save" style="border:1px solid #ddd; padding:12px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label><strong>Job name:</strong></label>
          <input type="text" name="job_name" placeholder="e.g., Smith extension" style="width:320px; padding:6px;">
          <button type="submit">Save Job</button>
        </div>

        <!-- carry current settings + quantities -->
        <input type="hidden" name="vat_mode" value="{{ vat_mode }}">
        <input type="hidden" name="purchase_mode" value="{{ purchase_mode }}">
        {% for p in products %}
          <input type="hidden" name="qty_{{ p.id }}" value="{{ qty_map.get(p.id,0) }}">
        {% endfor %}
      </form>

    {% endif %}

  </div>
</div>

</body>
</html>
